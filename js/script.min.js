let countdownInterval,totalSeconds=0,previousTime=null;const urlParams=new URLSearchParams(window.location.search),basePath=window.APP_BASE_PATH||"";if("transparent"===urlParams.get("bg")&&document.body.classList.add("transparent-bg"),"true"===urlParams.get("hideBtn")){const e=document.createElement("style");e.textContent=".timer-controls { display: none !important; }",document.head.appendChild(e)}const autoRestart="true"===urlParams.get("autoRestart");let isTickSoundEnabled=urlParams.has("tick")?"true"===urlParams.get("tick"):"false"!==localStorage.getItem("countdown_tick_sound"),isAlarmSoundEnabled=urlParams.has("alarm")?"true"===urlParams.get("alarm"):"false"!==localStorage.getItem("countdown_alarm_sound"),tickVolume=parseFloat(urlParams.get("tickVol")||localStorage.getItem("countdown_tick_volume")||"0.1"),alarmVolume=parseFloat(urlParams.get("alarmVol")||localStorage.getItem("countdown_alarm_volume")||"0.1"),translations={},currentLang=urlParams.get("lang")||localStorage.getItem("countdown_lang");const themes=[{id:"default",color:"#0f172a",text:"#ffffff"},{id:"sunset",color:"#431407",text:"#ffffff"},{id:"forest",color:"#022c22",text:"#ffffff"},{id:"berry",color:"#500724",text:"#ffffff"},{id:"abyss",color:"#000000",text:"#ffffff"},{id:"cloud",color:"#f0f9ff",text:"#0c4a6e"},{id:"peach",color:"#fff7ed",text:"#9a3412"},{id:"mint",color:"#ecfdf5",text:"#065f46"},{id:"lilac",color:"#faf5ff",text:"#6b21a8"},{id:"sand",color:"#fffbeb",text:"#92400e"},{id:"navy",color:"#0f172a",text:"#ffffff"},{id:"crimson",color:"#450a0a",text:"#ffffff"},{id:"charcoal",color:"#18181b",text:"#ffffff"},{id:"violet",color:"#2e1065",text:"#ffffff"},{id:"emerald",color:"#064e3b",text:"#ffffff"},{id:"rose",color:"#fff1f2",text:"#9f1239"},{id:"sky",color:"#f0f9ff",text:"#075985"},{id:"lemon",color:"#fefce8",text:"#854d0e"},{id:"ivory",color:"#fafaf9",text:"#57534e"},{id:"ice",color:"#ecfeff",text:"#155e75"}],supportedLangs=[{id:"it",label:"Italiano",flag:"it"},{id:"en",label:"English",flag:"gb"},{id:"es",label:"Español",flag:"es"},{id:"fr",label:"Français",flag:"fr"},{id:"de",label:"Deutsch",flag:"de"},{id:"pt",label:"Português",flag:"pt"},{id:"ru",label:"Русский",flag:"ru"},{id:"zh",label:"中文",flag:"cn"},{id:"ja",label:"日本語",flag:"jp"},{id:"ko",label:"한국어",flag:"kr"},{id:"ar",label:"العربية",flag:"sa"},{id:"hi",label:"हिन्दी",flag:"in"},{id:"tr",label:"Türkçe",flag:"tr"},{id:"nl",label:"Nederlands",flag:"nl"},{id:"pl",label:"Polski",flag:"pl"},{id:"sv",label:"Svenska",flag:"se"},{id:"vi",label:"Tiếng Việt",flag:"vn"},{id:"th",label:"ไทย",flag:"th"},{id:"el",label:"Ελληνικά",flag:"gr"},{id:"uk",label:"Українська",flag:"ua"}];if(!currentLang){const e=(navigator.language||"it").split("-")[0];currentLang=supportedLangs.some(t=>t.id===e)?e:"it"}const hoursInput=document.getElementById("hours"),minutesInput=document.getElementById("minutes"),startBtn=document.getElementById("start-btn"),resetBtn=document.getElementById("reset-btn"),pauseBtn=document.getElementById("pause-btn"),setupScreen=document.getElementById("setup-screen"),timerScreen=document.getElementById("timer-screen"),timerDisplay=document.getElementById("timer-display");hoursInput&&urlParams.has("h")&&(hoursInput.value=urlParams.get("h")),minutesInput&&urlParams.has("m")&&(minutesInput.value=urlParams.get("m")),urlParams.has("title")&&setTimeout(()=>{const e=document.getElementById("timer-title-input");e&&(e.value=urlParams.get("title"))},100),[hoursInput,minutesInput].forEach(e=>{e&&e.addEventListener("input",()=>{const t=e.max.length;e.value.length>t&&(e.value=e.value.slice(0,t));const n=parseInt(e.value),a=parseInt(e.max);!isNaN(n)&&!isNaN(a)&&n>a&&(e.value=a)})});let alarmSound=document.getElementById("alarm-sound");alarmSound||(alarmSound=document.createElement("audio"),alarmSound.id="alarm-sound",document.body.appendChild(alarmSound));const tickPool=[],POOL_SIZE=5;for(let e=0;e<5;e++){const e=new Audio(`${basePath}assets/sounds/tick/tick-1.mp3`);e.volume=tickVolume,e.preload="auto",tickPool.push(e)}function createDigitHtml(e,t){return`<div class="digit" id="${e}" data-value="${t}">\n        <div class="digit-inner">\n            <div class="digit-new">${t}</div>\n            <div class="digit-old">${t}</div>\n        </div>\n    </div>`}function updateDigit(e,t){const n=document.getElementById(e);if(!n)return;const a=n.dataset.value;if(a===t)return;const o=n.querySelector(".digit-inner"),s=n.querySelector(".digit-new"),i=n.querySelector(".digit-old");o&&s&&i&&(i.textContent=a,s.textContent=t,o.classList.remove("animating"),o.style.transform="translateY(-50%)",o.offsetWidth,o.classList.add("animating"),o.style.transform="",n.dataset.value=t)}function updateDisplay(){const e=Math.floor(totalSeconds/3600),t=Math.floor(totalSeconds%3600/60),n=totalSeconds%60;timerDisplay.classList.toggle("has-hours",e>0);const a=e<10?"0"+e:String(e),o=t<10?"0"+t:String(t),s=n<10?"0"+n:String(n),i=[];e>0&&(a.split("").forEach((e,t)=>i.push({type:"digit",val:e,id:`h-${t}`})),i.push({type:"sep",val:":",id:"sep-h"})),o.split("").forEach((e,t)=>i.push({type:"digit",val:e,id:`m-${t}`})),i.push({type:"sep",val:":",id:"sep-m"}),s.split("").forEach((e,t)=>i.push({type:"digit",val:e,id:`s-${t}`})),Array.from(timerDisplay.children).forEach(e=>{if(e.classList.contains("pop-out"))return;i.find(t=>t.id===e.id)||(e.classList.add("pop-out"),e.addEventListener("animationend",()=>e.remove()))});let l=null;if(i.forEach(e=>{let t=document.getElementById(e.id);if(t)"digit"===e.type&&updateDigit(e.id,e.val);else{const n=document.createElement("div");"sep"===e.type?n.innerHTML=`<span class="separator" id="${e.id}">:</span>`:n.innerHTML=createDigitHtml(e.id,e.val),t=n.firstElementChild,l?l.insertAdjacentElement("afterend",t):timerDisplay.prepend(t)}l=t}),previousTime={hStr:a,mStr:o,sStr:s},!timerScreen.classList.contains("hidden")){const t=e>0?`${a}:${o}:${s}`:`${o}:${s}`;document.title=`${t} - Work Countdown`}}function showNotification(e){resetIdleTimer();const t=document.querySelector(".custom-notification");t&&t.remove();const n=document.createElement("div");n.className="custom-notification",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slide-out-left 0.5s forwards",n.addEventListener("animationend",()=>{n.parentNode&&n.remove()})},3e3)}let endTime,idleTimeout,remainingTime=0,isPaused=!1,lastTickSecond=0;function saveTimerState(){if(urlParams.has("widget"))return;localStorage.setItem("countdown_active","true"),localStorage.setItem("countdown_is_paused",String(isPaused));const e=document.getElementById("timer-title-input");e&&localStorage.setItem("countdown_title",e.value),isPaused?(localStorage.setItem("countdown_remaining_time",String(remainingTime)),localStorage.removeItem("countdown_end_time")):(localStorage.setItem("countdown_end_time",String(endTime)),localStorage.removeItem("countdown_remaining_time"))}function clearTimerState(){urlParams.has("widget")||(localStorage.removeItem("countdown_active"),localStorage.removeItem("countdown_is_paused"),localStorage.removeItem("countdown_remaining_time"),localStorage.removeItem("countdown_end_time"),localStorage.removeItem("countdown_title"))}function restoreTimerState(){if(urlParams.has("widget"))return;if(!("true"===localStorage.getItem("countdown_active")))return;const e="true"===localStorage.getItem("countdown_is_paused"),n=localStorage.getItem("countdown_title")||"",a=document.getElementById("timer-title-input"),o=document.getElementById("timer-title-display");if(a&&(a.value=n),o&&(o.textContent=n,o.classList.add("visible")),setupScreen.classList.add("hidden"),timerScreen.classList.remove("hidden"),timerDisplay.classList.remove("hurry-up","finished"),previousTime=null,Array.from(timerDisplay.childNodes).forEach(e=>{e.nodeType===Node.TEXT_NODE&&e.remove()}),alarmSound.src&&""!==alarmSound.src||(alarmSound.src=`${basePath}assets/sounds/alarm/alarm-1.mp3`),e){if(remainingTime=parseInt(localStorage.getItem("countdown_remaining_time")||"0"),totalSeconds=Math.ceil(remainingTime/1e3),isPaused=!0,pauseBtn){pauseBtn.querySelector("i").className="fa-solid fa-play";const e=pauseBtn.querySelector("span");e&&(e.setAttribute("data-i18n","start_btn"),e.textContent=t("start_btn"))}updateDisplay()}else{const e=parseInt(localStorage.getItem("countdown_end_time")||"0"),n=Date.now();if(e>n){if(endTime=e,remainingTime=endTime-n,totalSeconds=Math.ceil(remainingTime/1e3),isPaused=!1,pauseBtn){pauseBtn.querySelector("i").className="fa-solid fa-pause";const e=pauseBtn.querySelector("span");e&&(e.setAttribute("data-i18n","stop_btn"),e.textContent=t("stop_btn"))}lastTickSecond=totalSeconds,runTick()}else totalSeconds=0,updateDisplay(),timerDisplay.classList.add("finished"),launchConfetti(),showNotification(t("notif_finished")),clearTimerState()}}function startTimer(){clearTimeout(countdownInterval);const e=parseInt(hoursInput.value)||0,n=parseInt(minutesInput.value)||0;if(totalSeconds=3600*e+60*n,totalSeconds<=0)return void showNotification(t("notif_min_time"));setupScreen.classList.add("hidden"),timerScreen.classList.remove("hidden");const a=document.getElementById("timer-title-input"),o=document.getElementById("timer-title-display");if(a&&o&&(o.textContent=a.value,o.classList.add("visible")),Array.from(timerDisplay.childNodes).forEach(e=>{e.nodeType===Node.TEXT_NODE&&e.remove()}),timerDisplay.classList.remove("hurry-up","finished"),previousTime=null,updateDisplay(),showNotification(t("notif_started")),isPaused=!1,pauseBtn){pauseBtn.querySelector("i").className="fa-solid fa-pause";const e=pauseBtn.querySelector("span");e&&(e.setAttribute("data-i18n","stop_btn"),e.textContent=t("stop_btn"))}alarmSound.src&&""!==alarmSound.src||(alarmSound.src=`${basePath}assets/sounds/alarm/alarm-1.mp3`),isAlarmSoundEnabled&&(alarmSound.volume=alarmVolume,alarmSound.play().then(()=>{alarmSound.pause(),alarmSound.currentTime=0}).catch(e=>console.warn("Alarm unlock failed:",e))),isTickSoundEnabled&&tickPool.forEach(e=>{e.play().then(()=>{e.pause(),e.currentTime=0}).catch(e=>console.warn("Tick pool unlock failed:",e))}),remainingTime=1e3*totalSeconds,endTime=Date.now()+remainingTime,lastTickSecond=totalSeconds,saveTimerState(),runTick()}function runTick(){if(isPaused)return;const e=Date.now(),n=endTime-e,a=Math.ceil(n/1e3);if(a<lastTickSecond){if(isTickSoundEnabled&&a>0){const e=tickPool[a%5];e.currentTime=0,e.playbackRate=a%2==0?1:1.1,e.play().catch(e=>console.warn("Tick play failed:",e))}lastTickSecond=a}if(totalSeconds=a<0?0:a,updateDisplay(),totalSeconds<=10&&totalSeconds>0&&timerDisplay.classList.add("hurry-up"),totalSeconds<=0){if(timerDisplay.classList.remove("hurry-up"),timerDisplay.classList.add("finished"),isAlarmSoundEnabled&&(alarmSound.src.includes("assets/sounds/alarm/alarm-1.mp3")||(alarmSound.src=`${basePath}assets/sounds/alarm/alarm-1.mp3`),alarmSound.volume=alarmVolume,alarmSound.loop=!0,alarmSound.play().catch(e=>console.log("Audio play failed:",e))),launchConfetti(),showNotification(t("notif_finished")),autoRestart)return void setTimeout(()=>{alarmSound.pause(),alarmSound.currentTime=0,startTimer()},2e3);clearTimerState()}else{countdownInterval=setTimeout(runTick,n%1e3+20)}}function togglePause(){if(!(totalSeconds<=0))if(isPaused){isPaused=!1,endTime=Date.now()+remainingTime,pauseBtn.querySelector("i").className="fa-solid fa-pause";const e=pauseBtn.querySelector("span");e&&(e.setAttribute("data-i18n","stop_btn"),e.textContent=t("stop_btn")),saveTimerState(),runTick()}else{isPaused=!0,clearTimeout(countdownInterval),remainingTime=endTime-Date.now(),pauseBtn.querySelector("i").className="fa-solid fa-play";const e=pauseBtn.querySelector("span");e&&(e.setAttribute("data-i18n","start_btn"),e.textContent=t("start_btn")),saveTimerState()}}function resetTimer(){clearTimeout(countdownInterval),isPaused=!1,document.body.classList.remove("idle-mode"),document.title="Work Countdown",clearTimerState(),alarmSound.pause(),alarmSound.currentTime=0,alarmSound.loop=!1,timerDisplay.classList.remove("hurry-up","finished");const e=document.getElementById("timer-title-display");e&&e.classList.remove("visible"),document.querySelectorAll(".confetti").forEach(e=>e.remove()),urlParams.has("widget")||(hoursInput&&(hoursInput.value=0),minutesInput&&(minutesInput.value=0)),urlParams.has("widget")?startTimer():(setupScreen.classList.remove("hidden"),timerScreen.classList.add("hidden"),document.fullscreenElement&&document.exitFullscreen().catch(e=>console.log("Exit fullscreen failed",e)),showNotification(t("notif_stopped")))}function setupThemeControls(){let e=0;const n=urlParams.get("theme")||localStorage.getItem("countdown_theme");if(n){const t=themes.findIndex(e=>e.id===n);-1!==t&&(e=t)}const a=document.getElementById("theme-modal"),o=document.getElementById("theme-open-btn"),s=a.querySelector(".close-modal"),i=document.getElementById("theme-grid"),l=document.getElementById("theme-search");function r(){a.classList.remove("open")}l&&l.addEventListener("input",e=>{const t=e.target.value.toLowerCase();i.querySelectorAll(".theme-option").forEach(e=>{const n=e.querySelector("span").textContent.toLowerCase();e.style.display=n.includes(t)?"flex":"none"})}),themes.forEach((n,a)=>{const o=document.createElement("div");o.className="theme-option",o.tabIndex=0,o.setAttribute("role","button"),o.setAttribute("aria-label",t("theme_"+n.id)),a===e&&o.classList.add("selected");const s=document.createElement("div");s.className="theme-preview",s.style.background=n.color;const l=document.createElement("span");l.setAttribute("data-i18n","theme_"+n.id),l.textContent=t("theme_"+n.id),o.appendChild(s),o.appendChild(l);const d=()=>{e=a,m(),r()};o.addEventListener("click",d),o.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),d())}),i.appendChild(o)}),o&&o.addEventListener("click",function(){a.classList.add("open");const e=document.getElementById("theme-search");e&&setTimeout(()=>e.focus(),50)}),s&&(s.addEventListener("click",r),s.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),r())})),a.addEventListener("click",e=>{e.target===a&&r()});const d=document.createElement("div");d.className="theme-nav-btn theme-nav-prev",d.tabIndex=0,d.setAttribute("role","button"),d.innerHTML="&#10094;",d.onclick=()=>u(-1),d.onkeydown=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),u(-1))};const c=document.createElement("div");function m(t=!1){const n=themes[e].id;urlParams.has("widget")||localStorage.setItem("countdown_theme",n),"default"===n?document.body.removeAttribute("data-theme"):document.body.setAttribute("data-theme",n),Array.from(i.children).forEach((t,n)=>{n===e?t.classList.add("selected"):t.classList.remove("selected")}),t||(document.body.classList.remove("theme-changing"),document.body.offsetWidth,document.body.classList.add("theme-changing"),setTimeout(()=>document.body.classList.remove("theme-changing"),600))}function u(t){e=(e+t+themes.length)%themes.length,m()}c.className="theme-nav-btn theme-nav-next",c.tabIndex=0,c.setAttribute("role","button"),c.innerHTML="&#10095;",c.onclick=()=>u(1),c.onkeydown=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),u(1))},document.body.appendChild(d),document.body.appendChild(c),n&&m(!0)}function setupTitleFeature(){const e=document.querySelector(".container"),n=e.querySelector(".input-group"),a=document.createElement("input");a.type="text",a.id="timer-title-input",a.className="timer-title-input",a.placeholder=t("timer_title_placeholder"),a.autocomplete="off",n&&e.insertBefore(a,n);const o=document.createElement("div");o.id="timer-title-display",timerScreen.prepend(o)}function launchConfetti(){const e=["var(--primary-color)","var(--secondary-color)","#ffffff","#fbbf24"];for(let t=0;t<60;t++){const t=document.createElement("div");t.className="confetti",t.style.left=100*Math.random()+"vw",t.style.animationDuration=3*Math.random()+2+"s",t.style.animationDelay=5*Math.random()+"s",t.style.backgroundColor=e[Math.floor(Math.random()*e.length)],t.style.setProperty("--drift",300*Math.random()-150+"px"),t.addEventListener("animationend",()=>t.remove()),document.body.appendChild(t)}}function resetIdleTimer(){if(timerScreen.classList.contains("hidden"))return document.body.classList.remove("idle-mode"),void clearTimeout(idleTimeout);document.body.classList.remove("idle-mode"),clearTimeout(idleTimeout),idleTimeout=setTimeout(()=>{timerScreen.classList.contains("hidden")||document.body.classList.add("idle-mode")},5e3)}setupThemeControls(),setupTitleFeature();let lastTouchStart=0,wasIdleAtTouchStart=!1;function setupAnimationSwitcher(){const e=document.getElementById("animation-toggle");let n="false"!==localStorage.getItem("countdown_animation");urlParams.has("anim")&&(n="true"===urlParams.get("anim")),applyAnimationState(n),e&&(e.checked=n,e.addEventListener("change",e=>{const n=e.target.checked;localStorage.setItem("countdown_animation",n),applyAnimationState(n),n&&showNotification(t("notif_anim_warning"))}));const a=document.getElementById("settings-animation-toggle");a&&(a.checked=n,a.addEventListener("change",t=>{e&&(e.checked=t.target.checked,e.dispatchEvent(new Event("change")))}),e&&e.addEventListener("change",e=>{a.checked=e.target.checked}))}function applyAnimationState(e){document.body.classList.toggle("no-animations",!e)}function setupSoundControls(){const e=document.getElementById("sound-modal"),t=document.getElementById("sound-toggle-btn"),n=e?e.querySelector(".close-modal"):null,a=document.getElementById("tick-sound-toggle"),o=document.getElementById("alarm-sound-toggle"),s=document.getElementById("tick-volume"),i=document.getElementById("alarm-volume"),l=document.getElementById("tick-volume-container"),r=document.getElementById("alarm-volume-container");function d(){l&&(l.style.display=isTickSoundEnabled?"block":"none"),r&&(r.style.display=isAlarmSoundEnabled?"block":"none")}function c(){e&&e.classList.remove("open")}a&&(a.checked=isTickSoundEnabled,a.addEventListener("change",e=>{isTickSoundEnabled=e.target.checked,localStorage.setItem("countdown_tick_sound",isTickSoundEnabled),d()})),o&&(o.checked=isAlarmSoundEnabled,o.addEventListener("change",e=>{isAlarmSoundEnabled=e.target.checked,localStorage.setItem("countdown_alarm_sound",isAlarmSoundEnabled),d()})),s&&(s.value=tickVolume,s.addEventListener("input",e=>{tickVolume=parseFloat(e.target.value),localStorage.setItem("countdown_tick_volume",tickVolume),tickPool.forEach(e=>e.volume=tickVolume)})),i&&(i.value=alarmVolume,i.addEventListener("input",e=>{alarmVolume=parseFloat(e.target.value),localStorage.setItem("countdown_alarm_volume",alarmVolume),alarmSound&&(alarmSound.volume=alarmVolume)})),d(),t&&t.addEventListener("click",function(){e&&e.classList.add("open")}),n&&n.addEventListener("click",c),e&&e.addEventListener("click",t=>{t.target===e&&c()})}function setupSettingsModal(){const e=document.getElementById("settings-modal"),t=document.getElementById("mobile-settings-btn"),n=e?e.querySelector(".close-modal"):null;if(!e||!t)return;t.addEventListener("click",()=>e.classList.add("open")),n&&n.addEventListener("click",()=>e.classList.remove("open")),e.addEventListener("click",t=>{t.target===e&&e.classList.remove("open")});const a={"settings-theme-btn":"theme-modal","settings-lang-btn":"lang-modal","settings-sound-btn":"sound-modal"};Object.keys(a).forEach(t=>{const n=document.getElementById(t);n&&n.addEventListener("click",()=>{e.classList.remove("open");const n=document.getElementById(a[t]);if(n){n.classList.add("from-settings"),n.classList.add("open");const e=n.querySelector(".search-input");e&&setTimeout(()=>e.focus(),50)}})}),document.querySelectorAll(".back-modal").forEach(t=>{t.addEventListener("click",n=>{n.stopPropagation();const a=t.closest(".modal");a&&(a.classList.remove("open"),a.classList.remove("from-settings")),e.classList.add("open")})});["theme-open-btn","lang-open-btn","sound-toggle-btn"].forEach(e=>{const t=document.getElementById(e),n=e.replace("-open-btn","-modal").replace("-toggle-btn","-modal");t&&t.addEventListener("click",()=>{const e=document.getElementById(n);e&&e.classList.remove("from-settings")})})}function setupLanguageControls(){if(urlParams.has("widget")&&urlParams.has("lang"))return;const e=document.getElementById("lang-modal"),t=document.getElementById("lang-open-btn"),n=e?e.querySelector(".close-modal"):null,a=document.getElementById("lang-list"),o=document.getElementById("lang-search");function s(){e.classList.remove("open")}e&&a&&(supportedLangs.forEach(e=>{const t=document.createElement("div");t.className="theme-option",t.tabIndex=0,t.setAttribute("role","button"),t.setAttribute("aria-label",e.label),t.dataset.langId=e.id,e.id===currentLang&&t.classList.add("selected");const n=document.createElement("div");n.className="theme-preview",n.style.background=`url('https://flagcdn.com/w80/${e.flag||e.id}.png') center/cover no-repeat`,n.style.backgroundColor="#f0f0f0";const o=document.createElement("span");o.textContent=e.label,t.appendChild(n),t.appendChild(o);const i=async()=>{await applyLanguage(e.id),s(),Array.from(a.children).forEach(t=>{t.dataset.langId===e.id?t.classList.add("selected"):t.classList.remove("selected")})};t.addEventListener("click",i),t.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i())}),a.appendChild(t)}),o&&o.addEventListener("input",e=>{const t=e.target.value.toLowerCase();Array.from(a.children).forEach(e=>{const n=e.querySelector("span").textContent.toLowerCase();e.style.display=n.includes(t)?"flex":"none"})}),t&&t.addEventListener("click",function(){e.classList.add("open"),o&&setTimeout(()=>o.focus(),50),Array.from(a.children).forEach(e=>{e.dataset.langId===currentLang?e.classList.add("selected"):e.classList.remove("selected")})}),n&&(n.addEventListener("click",s),n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),s())})),e.addEventListener("click",t=>{t.target===e&&s()}))}async function loadTranslations(){await applyLanguage(currentLang)}function t(e){return translations[currentLang]&&translations[currentLang][e]||e}async function applyLanguage(e){if(!translations[e])try{const t=await fetch(`${basePath}assets/languages/${e}.json`);t.ok?translations[e]=await t.json():console.error(`Failed to load ${e}.json`)}catch(e){console.error("Translation load error:",e)}if(translations[e]&&!translations[e].reset_btn&&(translations[e].reset_btn="it"===e?"Resetta":"Reset"),translations[e]&&(translations[e].modal_sound_title||(translations[e].modal_sound_title="it"===e?"Impostazioni Suono":"Sound Settings"),translations[e].tick_sound_label||(translations[e].tick_sound_label="it"===e?"Suono Ticchettio":"Tick Sound"),translations[e].alarm_sound_label||(translations[e].alarm_sound_label="it"===e?"Suono Allarme":"Alarm Sound")),!translations[e]&&!translations[e="it"])try{const t=await fetch(`${basePath}assets/languages/${e}.json`);t.ok&&(translations[e]=await t.json())}catch(e){console.error("Fallback translation load error:",e)}currentLang=e,urlParams.has("widget")||localStorage.setItem("countdown_lang",e),document.documentElement.setAttribute("lang",e),document.documentElement.setAttribute("data-lang",e),document.querySelectorAll("[data-i18n]").forEach(e=>{const n=e.getAttribute("data-i18n");n&&(e.textContent=t(n))});const n=document.getElementById("timer-title-input");n&&(n.placeholder=t("timer_title_placeholder")),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{e.placeholder=t(e.getAttribute("data-i18n-placeholder"))})}function startBlobAnimation(){const e=document.querySelectorAll(".blob");function t(n=!1){document.body.classList.contains("no-animations")||(e.forEach(e=>{const t=Math.random()*(window.innerWidth-e.clientWidth),a=Math.random()*(window.innerHeight-e.clientHeight);n?(e.style.transition="none",e.style.transform=`translate(${t}px, ${a}px)`,e.offsetWidth,e.style.transition=""):e.style.transform=`translate(${t}px, ${a}px)`}),setTimeout(t,2e4))}t(!0);const n=document.getElementById("animation-toggle");n&&n.addEventListener("change",e=>{e.target.checked&&t()})}function setupOnboarding(){if(urlParams.has("widget"))return;if("true"===localStorage.getItem("countdown_onboarding_complete"))return;const e=[{icon:'<i class="fa-solid fa-hand-sparkles"></i>',titleKey:"onboarding_1_title",descKey:"onboarding_1_desc"},{id:"language",icon:'<i class="fa-solid fa-globe"></i>',titleKey:"modal_lang_title",descKey:null,customContent:e=>{const t=createCustomSelect(supportedLangs,currentLang,e=>{applyLanguage(e)},e=>{const t=document.createElement("div");t.className="onboarding-option-icon",t.style.backgroundImage=`url("https://flagcdn.com/w40/${e.flag||e.id}.png")`;const n=document.createElement("span");n.textContent=e.label;const a=document.createDocumentFragment();return a.appendChild(t),a.appendChild(n),a});e.appendChild(t)}},{id:"theme",icon:'<i class="fa-solid fa-palette"></i>',titleKey:"modal_theme_title",descKey:null,customContent:e=>{const n=localStorage.getItem("countdown_theme")||"default",a=createCustomSelect(themes,n,e=>{const t=themes.findIndex(t=>t.id===e);if(-1!==t){const e=themes[t].id;localStorage.setItem("countdown_theme",e),"default"===e?document.body.removeAttribute("data-theme"):document.body.setAttribute("data-theme",e);const n=document.getElementById("theme-grid");n&&Array.from(n.children).forEach((e,n)=>{n===t?e.classList.add("selected"):e.classList.remove("selected")})}},e=>{const n=document.createElement("div");n.className="theme-preview-icon",n.style.background=e.color;const a=document.createElement("span");a.textContent=t("theme_"+e.id);const o=document.createDocumentFragment();return o.appendChild(n),o.appendChild(a),o});e.appendChild(a)}},{id:"animations",icon:'<i class="fa-solid fa-wand-magic-sparkles"></i>',titleKey:"onboarding_anim_title",descKey:"onboarding_anim_desc",customContent:e=>{const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="center",t.style.marginTop="1rem";const n=document.createElement("label");n.className="switch";const a=document.createElement("input");a.type="checkbox",a.checked="false"!==localStorage.getItem("countdown_animation");const o=document.createElement("span");o.className="slider",n.appendChild(a),n.appendChild(o),t.appendChild(n),e.appendChild(t),a.addEventListener("change",e=>{const t=e.target.checked;localStorage.setItem("countdown_animation",t),applyAnimationState(t);const n=document.getElementById("animation-toggle");n&&(n.checked=t)})}},{icon:'<i class="fa-solid fa-rocket"></i>',titleKey:"onboarding_3_title",descKey:"onboarding_3_desc"}];let n=0;const a=document.createElement("div");a.className="onboarding-overlay",a.innerHTML='\n        <div class="onboarding-card">\n            <div class="onboarding-icon"></div>\n            <h2 class="onboarding-title"></h2>\n            <p class="onboarding-desc"></p>\n            <div class="onboarding-custom-content"></div>\n            <div class="onboarding-dots"></div>\n            <div class="onboarding-actions">\n                <button class="btn-secondary"><span id="ob-skip"></span></button>\n                <button class="btn-primary"><span id="ob-next"></span></button>\n            </div>\n        </div>\n    ',document.body.appendChild(a);const o=a.querySelector(".onboarding-icon"),s=a.querySelector(".onboarding-title"),i=a.querySelector(".onboarding-desc"),l=a.querySelector(".onboarding-custom-content"),r=a.querySelector(".onboarding-dots"),d=document.getElementById("ob-skip"),c=document.getElementById("ob-next");function m(){const a=e[n];o.innerHTML=a.icon,s.setAttribute("data-i18n",a.titleKey),s.textContent=t(a.titleKey),a.descKey?(i.style.display="block",i.setAttribute("data-i18n",a.descKey),i.textContent=t(a.descKey)):i.style.display="none",l.innerHTML="",a.customContent&&a.customContent(l),r.innerHTML=e.map((e,t)=>`<div class="dot ${t===n?"active":""}"></div>`).join(""),d.textContent=t("onboarding_skip"),c.textContent=n===e.length-1?t("onboarding_start"):t("onboarding_next")}function u(){a.classList.remove("visible"),setTimeout(()=>a.remove(),500),localStorage.setItem("countdown_onboarding_complete","true"),n===e.length-1&&launchConfetti()}c.addEventListener("click",()=>{n<e.length-1?(n++,m()):u()}),d.addEventListener("click",u),m(),setTimeout(()=>a.classList.add("visible"),500)}function createCustomSelect(e,t,n,a){const o=document.createElement("div");o.className="onboarding-custom-select";const s=document.createElement("div");s.className="onboarding-select-trigger";const i=e.find(e=>e.id===t)||e[0],l=e=>{s.innerHTML="",a?s.appendChild(a(e)):s.textContent=e.label||e.id;const t=document.createElement("i");t.className="fa-solid fa-chevron-down",t.style.fontSize="0.8rem",t.style.opacity="0.7",s.appendChild(t)};l(i);const r=document.createElement("div");return r.className="onboarding-options",e.forEach(e=>{const o=document.createElement("div");o.className="onboarding-option",e.id===t&&o.classList.add("selected"),a?o.appendChild(a(e)):o.textContent=e.label||e.id,o.addEventListener("click",t=>{t.stopPropagation(),n(e.id),l(e),r.classList.remove("open"),r.querySelectorAll(".onboarding-option").forEach(e=>e.classList.remove("selected")),o.classList.add("selected")}),r.appendChild(o)}),s.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".onboarding-options.open").forEach(e=>{e!==r&&e.classList.remove("open")}),r.classList.toggle("open")}),document.addEventListener("click",e=>{o.contains(e.target)||r.classList.remove("open")}),o.appendChild(s),o.appendChild(r),o}document.addEventListener("touchstart",()=>{lastTouchStart=Date.now(),wasIdleAtTouchStart=document.body.classList.contains("idle-mode")},{passive:!0}),["mousemove","keypress","keydown","scroll","touchmove"].forEach(e=>document.addEventListener(e,resetIdleTimer,{passive:!0})),document.addEventListener("click",e=>{if(timerScreen.classList.contains("hidden"))return void resetIdleTimer();if(e.target.closest("button, input, a, .header-controls, .theme-nav-btn, .modal, .switch, label"))resetIdleTimer();else{if(Date.now()-lastTouchStart<500&&wasIdleAtTouchStart)return void resetIdleTimer();document.body.classList.contains("idle-mode")?resetIdleTimer():(document.body.classList.add("idle-mode"),clearTimeout(idleTimeout))}}),setupAnimationSwitcher(),setupSoundControls(),setupSettingsModal(),setupLanguageControls(),startBtn&&startBtn.addEventListener("click",startTimer),resetBtn&&resetBtn.addEventListener("click",resetTimer),pauseBtn&&pauseBtn.addEventListener("click",togglePause),document.addEventListener("keydown",e=>{const t=document.querySelector(".modal.open");if("Tab"===e.key){const n=t||document.body,a='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',o=Array.from(n.querySelectorAll(a)).filter(e=>!(null===e.offsetParent||!t&&e.closest(".modal")));if(o.length>0){const t=o[0],n=o[o.length-1];e.shiftKey?document.activeElement===t&&(e.preventDefault(),n.focus()):document.activeElement===n&&(e.preventDefault(),t.focus())}return}if(t)"Escape"===e.key&&t.classList.remove("open");else if(timerScreen.classList.contains("hidden")){if(!setupScreen.classList.contains("hidden")&&"Enter"===e.key){if("BUTTON"===document.activeElement.tagName)return;startTimer()}}else if("Escape"===e.key)e.preventDefault(),resetTimer();else if(" "===e.key){if("BUTTON"===document.activeElement.tagName)return;e.preventDefault(),togglePause()}else if("m"===e.key.toLowerCase()){const e=document.getElementById("sound-toggle-btn");e&&e.click()}else"f"===e.key.toLowerCase()&&(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(()=>{}))});const translationsLoaded=loadTranslations().then(()=>{setupOnboarding(),restoreTimerState()});if(urlParams.has("widget")){const e=document.querySelector(".ad-slot-footer");e&&(e.style.display="none");const t=document.querySelector(".header-controls");t&&(t.style.display="none"),setupScreen&&setupScreen.classList.add("hidden"),timerScreen&&timerScreen.classList.remove("hidden");const n=hoursInput&&parseInt(hoursInput.value)||0,a=minutesInput&&parseInt(minutesInput.value)||0;totalSeconds=3600*n+60*a,updateDisplay();const o=()=>{let e=document.getElementById("widget-branding");const t="Made with Timer.sildev.dev",n="https://timer.sildev.dev";e||(e=document.createElement("a"),e.id="widget-branding",e.className="widget-branding",e.target="_blank",document.body.appendChild(e)),e.getAttribute("href")!==n&&(e.href=n),e.textContent.trim()!==t&&(e.textContent=t);const a=window.getComputedStyle(e);"none"!==a.display&&"hidden"!==a.visibility&&"0"!==a.opacity||(e.style.cssText="",e.className="widget-branding")};setInterval(o,2e3),o()}urlParams.has("widget")&&(urlParams.has("h")||urlParams.has("m"))&&setTimeout(()=>{startTimer()},500),startBlobAnimation();const loaderScreen=document.getElementById("loading-screen"),loaderBar=document.querySelector(".loader-bar"),loaderPercentage=document.querySelector(".loader-percentage"),loaderText=document.querySelector(".loader-text");if(urlParams.has("widget")&&loaderScreen&&loaderScreen.remove(),loaderScreen&&loaderBar&&!urlParams.has("widget")){let e=0;const t={it:["Caricamento risorse...","Preparazione font...","Configurazione temi...","Avvio sistema...","Pronto!"],en:["Loading resources...","Preparing fonts...","Configuring themes...","Starting system...","Ready!"],es:["Cargando recursos...","Preparando fuentes...","Configurando temas...","Iniciando sistema...","¡Listo!"],fr:["Chargement des ressources...","Préparation des polices...","Configuration des thèmes...","Démarrage du système...","Prêt !"],de:["Ressourcen laden...","Schriftarten vorbereiten...","Themen konfigurieren...","System starten...","Bereit!"],pt:["Carregando recursos...","Preparando fontes...","Configurando temas...","Iniciando sistema...","Pronto!"],ru:["Загрузка ресурсов...","Подготовка шрифтов...","Настройка тем...","Запуск системы...","Готово!"],zh:["加载资源...","准备字体...","配置主题...","启动系统...","准备就绪！"],ja:["リソースを読み込んでいます...","フォントを準備中...","テーマを設定中...","システムを起動中...","準備完了！"],ko:["리소스를 로드 중...","글꼴 준비 중...","테마 구성 중...","시스템 시작 중...","준비 완료!"],ar:["جارٍ تحميل الموارد...","جارٍ إعداد الخطوط...","جارٍ تكوين السمات...","جارٍ بدء النظام...","جاهز!"],hi:["संसाधन लोड हो रहे हैं...","फ़ॉन्ट तैयार किए जा रहे हैं...","थीम कॉन्फ़िगर की जा रही हैं...","सिस्टम शुरू हो रहा है...","तैयार!"],tr:["Kaynaklar yükleniyor...","Yazı tipleri hazırlanıyor...","Temalar yapılandırılıyor...","Sistem başlatılıyor...","Hazır!"],nl:["Bronnen laden...","Lettertypen voorbereiden...","Thema's configureren...","Systeem starten...","Klaar!"],pl:["Ładowanie zasobów...","Przygotowywanie czcionek...","Konfigurowanie motywów...","Uruchamianie systemu...","Gotowe!"],sv:["Laddar resurser...","Förbereder typsnitt...","Konfigurerar teman...","Startar systemet...","Redo!"],vi:["Đang tải tài nguyên...","Đang chuẩn bị phông chữ...","Đang cấu hình chủ đề...","Đang khởi động hệ thống...","Sẵn sàng!"],th:["กำลังโหลดทรัพยากร...","กำลังเตรียมแบบอักษร...","กำลังกำหนดค่าธีม...","กำลังเริ่มระบบ...","พร้อม!"],el:["Φόρτωση πόρων...","Προετοιμασία γραμματοσειρών...","Διαμόρφωση θεμάτων...","Εκκίνηση συστήματος...","Έτοιμο!"],uk:["Завантаження ресурсів...","Підготовка шрифтів...","Налаштування тем...","Запуск системи...","Готово!"]},n=t[currentLang]||t.en,a=setInterval(()=>{if(e+=10*Math.random(),e>90&&(e=90),loaderBar.style.setProperty("--progress",`${e}%`),loaderPercentage&&(loaderPercentage.textContent=`${Math.round(e)}%`),loaderText){const t=Math.floor(e/100*(n.length-1));loaderText.textContent=n[t]||n[0]}},100);Promise.all([document.fonts.ready,translationsLoaded,new Promise(e=>{"complete"===document.readyState?e():window.addEventListener("load",e)})]).catch(e=>console.error("Loading error:",e)).finally(()=>{clearInterval(a),loaderBar.style.setProperty("--progress","100%"),loaderPercentage&&(loaderPercentage.textContent="100%"),loaderText&&(loaderText.textContent=n[n.length-1]),setTimeout(()=>{loaderScreen.classList.add("hidden"),setTimeout(()=>loaderScreen.remove(),500)},500)})}